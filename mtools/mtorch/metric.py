import torch
from mtool.mtorch.mutils import get_matrix_sqrt


## 计算两个多元高斯分布的Wessertein距离
def Gaussian_Wasserstein(mu, sigma):
    '''
    计算两个多元高斯分布的Wessertein距离
    \begin{aligned}
    d^{2}=
    &\left\|m_{1}-m_{2}\right\|_{2}^{2}+\operatorname{Tr}\left(\Sigma_{1}+\Sigma_{2}-2\left(\Sigma_{1}^{1 / 2} \Sigma_{2} \Sigma_{1}^{1 / 2}\right)^{1 / 2}\right) \\
    &\left\|m_{1}-m_{2}\right\|_{2}^{2}+=\left\|\Sigma_{1}^{1 / 2}-\Sigma_{2}^{1 / 2}\right\|_{\text {Frobenius }}^{2}
    \end{aligned}
    :param mu:    [1, N,num_dimension]
    :param sigma: [1, N,num_dimension]
    :return distance: [N.N]
    :return:
    '''
    p1 = Euclidean_Distance(mu)
    sqrt, _ = get_matrix_sqrt(sigma)
    p2 = Euclidean_Distance(sqrt.view(sqrt.size(0), -1))
    return p1 + p2


def Euclidean_Distance(embeddings):
    t1 = embeddings.unsqueeze(1).expand(len(embeddings), len(embeddings), embeddings.shape[1])
    t2 = embeddings.unsqueeze(0).expand(len(embeddings), len(embeddings), embeddings.shape[1])
    d = (t1 - t2).pow(2).sum(2)
    return d


if __name__ == '__main__':
    import numpy as np

    mu = [[0.8174, 0.6554, 0.5676, 0.9565, 0.7089, -0.0169, 0.1886, 0.2516, 0.3594, 0.5637, 0.8815, 0.0630],
          [0.0032, 0.6386, 0.4591, 0.0920, 0.0248, 0.7418, 0.0038, 0.8328, 0.5476, 0.9787, 0.5914, 0.7535],
          [0.5250, 0.7940, 0.9088, 0.4054, 0.1831, 0.0765, 0.7418, 0.2749, 0.4665, 0.7027, 0.0149, 0.9915],
          [0.6881, 0.5176, 0.6150, 1.0113, 0.9967, 0.1980, 0.4507, 0.2717, 0.4790, 0.0406, 0.0952, -0.0262],
          [0.5751, 0.7743, 0.9643, 0.3290, 0.2329, 0.9522, 0.3252, 0.2911, 0.7362, 0.6609, 0.3018, 0.6087],
          [0.1147, 0.5423, 0.1279, 0.4184, 0.4777, 0.5702, 0.5474, 0.5810, 0.7096, 0.1120, 1.0064, 0.6950]]

    cov = [[[1.0050e+00, 4.8673e-03, -1.2090e-02, -6.5672e-03, -7.9220e-03, -2.3502e-03, -7.9895e-03, -9.4807e-03,
             5.8736e-03, 2.8994e-03, 5.4592e-03, -9.5803e-03],
            [4.8673e-03, 9.9799e-01, -3.6595e-03, 8.4185e-04, -1.2983e-03, -7.1728e-03, -1.1306e-02, -3.5534e-03,
             -1.6243e-04, 6.7430e-03, 6.6287e-03, -1.4733e-02],
            [-1.2090e-02, -3.6595e-03, 9.9371e-01, -3.0406e-03, 2.3508e-03, 1.7525e-03, 1.0218e-02, 5.2603e-03,
             -1.5904e-03,
             -8.4471e-03, -8.5904e-03, 1.5737e-02],
            [-6.5672e-03, 8.4185e-04, -3.0406e-03, 9.9130e-01, -7.4163e-04, 5.4805e-03, 8.5293e-03, 1.6832e-03,
             1.0079e-03,
             -6.4510e-03, -7.5538e-03, 1.4458e-02],
            [-7.9220e-03, -1.2983e-03, 2.3508e-03, -7.4163e-04, 1.0017e+00, 3.0669e-03, 8.5877e-03, 4.5547e-03,
             -2.5424e-03,
             -4.9874e-03, -6.7421e-03, 1.6470e-02],
            [-2.3502e-03, -7.1728e-03, 1.7525e-03, 5.4805e-03, 3.0669e-03, 9.8661e-01, -7.3964e-03, 3.2586e-03,
             -6.9358e-03,
             9.5280e-03, 1.1263e-02, 1.9545e-03],
            [-7.9895e-03, -1.1306e-02, 1.0218e-02, 8.5293e-03, 8.5877e-03, -7.3964e-03, 9.9257e-01, 7.7797e-03,
             -8.5606e-03,
             6.3486e-03, 6.2729e-03, -4.2647e-03],
            [-9.4807e-03, -3.5534e-03, 5.2603e-03, 1.6832e-03, 4.5547e-03, 3.2586e-03, 7.7797e-03, 1.0063e+00,
             -3.3132e-03,
             -5.0758e-03, -7.2410e-03, 1.2185e-02],
            [5.8736e-03, -1.6243e-04, -1.5904e-03, 1.0079e-03, -2.5424e-03, -6.9358e-03, -8.5606e-03, -3.3132e-03,
             9.9468e-01, 6.7477e-03, 8.7015e-03, -9.4018e-03],
            [2.8994e-03, 6.7430e-03, -8.4471e-03, -6.4510e-03, -4.9874e-03, 9.5280e-03, 6.3486e-03, -5.0758e-03,
             6.7477e-03,
             9.8661e-01, -9.6522e-03, -1.4325e-03],
            [5.4592e-03, 6.6287e-03, -8.5904e-03, -7.5538e-03, -6.7421e-03, 1.1263e-02, 6.2729e-03, -7.2410e-03,
             8.7015e-03,
             -9.6522e-03, 9.8534e-01, -3.8494e-03],
            [-9.5803e-03, -1.4733e-02, 1.5737e-02, 1.4458e-02, 1.6470e-02, 1.9545e-03, -4.2647e-03, 1.2185e-02,
             -9.4018e-03,
             -1.4325e-03, -3.8494e-03, 9.9645e-01]], [
               [9.7823e-01, -7.1084e-03, 9.4309e-03, 1.4373e-02, 1.9770e-02, 3.7371e-03, -2.9992e-02, 2.5441e-02,
                -2.7191e-02, 2.8563e-02, 1.6289e-02, 2.0206e-02],
               [-7.1084e-03, 1.0098e+00, -1.0347e-02, -1.0609e-02, -5.6233e-03, -6.5552e-03, -2.3575e-02, 3.7550e-03,
                -5.8124e-03, 1.2581e-02, -1.7859e-03, -8.2402e-04],
               [9.4309e-03, -1.0347e-02, 1.0144e+00, 8.5124e-03, 5.8966e-03, 3.5939e-03, 1.7865e-02, -4.8753e-03,
                1.9557e-03, -1.2652e-02, 1.8159e-03, 3.3955e-04],
               [1.4373e-02, -1.0609e-02, 8.5124e-03, 1.0154e+00, 5.4209e-04, 7.6540e-03, 2.9323e-02, -1.1402e-02,
                7.9811e-03, -2.2323e-02, -4.2928e-03, -2.5319e-03],
               [1.9770e-02, -5.6233e-03, 5.8966e-03, 5.4209e-04, 1.0078e+00, 3.1982e-03, 2.3225e-02, -1.6171e-02,
                1.3032e-02, -2.2106e-02, -6.5356e-03, -9.0761e-03],
               [3.7371e-03, -6.5552e-03, 3.5939e-03, 7.6540e-03, 3.1982e-03, 1.0074e+00, 2.6315e-03, -1.3430e-03,
                -4.9062e-03, -3.8830e-03, 1.5450e-03, 6.9399e-04],
               [-2.9992e-02, -2.3575e-02, 1.7865e-02, 2.9323e-02, 2.3225e-02, 2.6315e-03, 9.9866e-01, 2.7305e-02,
                -3.6045e-02, 2.8205e-02, 2.3771e-02, 2.2329e-02],
               [2.5441e-02, 3.7550e-03, -4.8753e-03, -1.1402e-02, -1.6171e-02, -1.3430e-03, 2.7305e-02, 9.7679e-01,
                2.2998e-02, -2.4830e-02, -1.3684e-02, -1.5931e-02],
               [-2.7191e-02, -5.8124e-03, 1.9557e-03, 7.9811e-03, 1.3032e-02, -4.9062e-03, -3.6045e-02, 2.2998e-02,
                9.8553e-01, 2.8146e-02, 1.3527e-02, 1.6259e-02],
               [2.8563e-02, 1.2581e-02, -1.2652e-02, -2.2323e-02, -2.2106e-02, -3.8830e-03, 2.8205e-02, -2.4830e-02,
                2.8146e-02, 9.7432e-01, -1.6423e-02, -1.6832e-02],
               [1.6289e-02, -1.7859e-03, 1.8159e-03, -4.2928e-03, -6.5356e-03, 1.5450e-03, 2.3771e-02, -1.3684e-02,
                1.3527e-02, -1.6423e-02, 9.9784e-01, -6.5564e-03],
               [2.0206e-02, -8.2402e-04, 3.3955e-04, -2.5319e-03, -9.0761e-03, 6.9399e-04, 2.2329e-02, -1.5931e-02,
                1.6259e-02, -1.6832e-02, -6.5564e-03, 1.0008e+00]], [
               [9.9709e-01, 4.9735e-03, 4.5605e-03, 8.3926e-04, -3.3328e-03, -1.8882e-02, 1.7824e-02, 2.0668e-03,
                -5.5294e-03, 6.8906e-03, -6.9659e-03, 1.0107e-02],
               [4.9735e-03, 1.0030e+00, -1.6556e-03, -4.6753e-03, -9.0070e-03, -1.1465e-02, 1.1801e-02, -8.9960e-03,
                3.8901e-03, -9.7659e-04, -1.0097e-02, 2.1252e-03],
               [4.5605e-03, -1.6556e-03, 9.9225e-01, -2.0719e-03, 1.1255e-03, 1.5948e-02, -1.4991e-02, -3.4170e-03,
                7.2172e-03, -5.3232e-03, 9.4148e-03, -1.0796e-02],
               [8.3926e-04, -4.6753e-03, -2.0719e-03, 1.0025e+00, 3.9802e-03, 1.5931e-02, -1.7002e-02, 4.7006e-04,
                3.4937e-03, -2.5472e-03, 8.8050e-03, -8.4586e-03],
               [-3.3328e-03, -9.0070e-03, 1.1255e-03, 3.9802e-03, 1.0095e+00, 1.4407e-02, -1.8246e-02, 4.3873e-03,
                -1.1981e-03, 1.1676e-03, 1.0751e-02, -4.2797e-03],
               [-1.8882e-02, -1.1465e-02, 1.5948e-02, 1.5931e-02, 1.4407e-02, 9.8646e-01, 1.6269e-02, 1.7849e-02,
                -1.8895e-02, 1.3072e-02, 1.3970e-04, 2.0441e-02],
               [1.7824e-02, 1.1801e-02, -1.4991e-02, -1.7002e-02, -1.8246e-02, 1.6269e-02, 9.9923e-01, -1.9011e-02,
                1.8905e-02, -1.1402e-02, 4.0044e-03, -1.3365e-02],
               [2.0668e-03, -8.9960e-03, -3.4170e-03, 4.7006e-04, 4.3873e-03, 1.7849e-02, -1.9011e-02, 1.0028e+00,
                3.9540e-03, -5.0892e-03, 5.6443e-03, -1.0194e-02],
               [-5.5294e-03, 3.8901e-03, 7.2172e-03, 3.4937e-03, -1.1981e-03, -1.8895e-02, 1.8905e-02, 3.9540e-03,
                9.9238e-01, 7.7571e-03, -5.2621e-03, 1.3179e-02],
               [6.8906e-03, -9.7659e-04, -5.3232e-03, -2.5472e-03, 1.1676e-03, 1.3072e-02, -1.1402e-02, -5.0892e-03,
                7.7571e-03, 9.9578e-01, 6.1839e-04, -1.1681e-02],
               [-6.9659e-03, -1.0097e-02, 9.4148e-03, 8.8050e-03, 1.0751e-02, 1.3970e-04, 4.0044e-03, 5.6443e-03,
                -5.2621e-03, 6.1839e-04, 9.9365e-01, 3.6777e-03],
               [1.0107e-02, 2.1252e-03, -1.0796e-02, -8.4586e-03, -4.2797e-03, 2.0441e-02, -1.3365e-02, -1.0194e-02,
                1.3179e-02, -1.1681e-02, 3.6777e-03, 9.7839e-01]], [
               [1.0052e+00, -8.7743e-03, 1.6224e-03, 8.3454e-03, 9.6310e-03, -3.1768e-03, -9.8422e-04, 6.5074e-03,
                -6.3421e-03, -1.3894e-02, -1.6117e-02, -1.7877e-02],
               [-8.7743e-03, 9.9986e-01, 3.7434e-03, 1.1587e-02, 1.3569e-02, -8.9808e-03, -9.7500e-04, 1.0367e-02,
                -1.0735e-02, -1.1288e-02, -1.3074e-02, -1.5332e-02],
               [1.6224e-03, 3.7434e-03, 1.0083e+00, -4.3774e-03, -7.6880e-03, 9.3420e-03, -4.4796e-03, -5.6248e-03,
                3.3581e-03, 1.1570e-02, 1.3257e-02, 8.2845e-03],
               [8.3454e-03, 1.1587e-02, -4.3774e-03, 9.8250e-01, -1.5833e-02, 1.0823e-02, -2.8780e-03, -1.4216e-02,
                1.1006e-02, 8.9187e-03, 7.6794e-03, 1.2715e-02],
               [9.6310e-03, 1.3569e-02, -7.6880e-03, -1.5833e-02, 9.7585e-01, 1.2007e-02, -2.4970e-03, -1.6718e-02,
                1.3859e-02, 1.1172e-02, 8.5858e-03, 1.3784e-02],
               [-3.1768e-03, -8.9808e-03, 9.3420e-03, 1.0823e-02, 1.2007e-02, 1.0074e+00, -3.3303e-03, 8.3001e-03,
                -6.7104e-03, -6.9324e-03, -8.1974e-03, -1.7475e-02],
               [-9.8422e-04, -9.7500e-04, -4.4796e-03, -2.8780e-03, -2.4970e-03, -3.3303e-03, 1.0047e+00, -3.9654e-03,
                -4.8215e-04, 3.5742e-03, -2.9634e-03, -6.5190e-03],
               [6.5074e-03, 1.0367e-02, -5.6248e-03, -1.4216e-02, -1.6718e-02, 8.3001e-03, -3.9654e-03, 9.9442e-01,
                9.6117e-03, 1.4023e-02, 1.0796e-02, 1.7128e-02],
               [-6.3421e-03, -1.0735e-02, 3.3581e-03, 1.1006e-02, 1.3859e-02, -6.7104e-03, -4.8215e-04, 9.6117e-03,
                1.0019e+00, -1.2028e-02, -1.2573e-02, -1.9249e-02],
               [-1.3894e-02, -1.1288e-02, 1.1570e-02, 8.9187e-03, 1.1172e-02, -6.9324e-03, 3.5742e-03, 1.4023e-02,
                -1.2028e-02, 1.0117e+00, 1.1655e-02, 1.6952e-02],
               [-1.6117e-02, -1.3074e-02, 1.3257e-02, 7.6794e-03, 8.5858e-03, -8.1974e-03, -2.9634e-03, 1.0796e-02,
                -1.2573e-02, 1.1655e-02, 1.0077e+00, 8.9339e-03],
               [-1.7877e-02, -1.5332e-02, 8.2845e-03, 1.2715e-02, 1.3784e-02, -1.7475e-02, -6.5190e-03, 1.7128e-02,
                -1.9249e-02, 1.6952e-02, 8.9339e-03, 1.0095e+00]], [
               [1.0026e+00, 6.5328e-03, 2.1925e-03, -1.1137e-02, -9.0769e-03, 1.9328e-02, -1.1051e-03, -9.6519e-03,
                1.1300e-02, -4.7062e-03, -3.8818e-03, -5.4262e-03],
               [6.5328e-03, 9.9607e-01, 5.4537e-03, 3.0078e-05, -7.4852e-05, 1.6128e-02, 2.1900e-04, -1.9646e-03,
                6.9660e-03, -4.1514e-03, 8.3130e-04, -2.7331e-03],
               [2.1925e-03, 5.4537e-03, 9.8616e-01, -3.5822e-03, -1.7619e-03, -1.2645e-02, 6.1140e-03, -4.9123e-04,
                3.3132e-03, -3.4634e-03, 1.3615e-03, -2.2931e-04],
               [-1.1137e-02, 3.0078e-05, -3.5822e-03, 9.9741e-01, 7.4635e-03, -1.8611e-02, 4.1133e-03, 1.2205e-02,
                -8.4402e-03, 6.9030e-03, 5.4126e-03, 1.0746e-02],
               [-9.0769e-03, -7.4851e-05, -1.7619e-03, 7.4635e-03, 1.0004e+00, -1.8546e-02, 6.0278e-03, 1.1886e-02,
                -9.1059e-03, 9.0760e-03, 4.5854e-03, 1.1655e-02],
               [1.9328e-02, 1.6128e-02, -1.2645e-02, -1.8611e-02, -1.8546e-02, 9.8438e-01, 1.2057e-02, -2.0102e-02,
                1.9741e-02, -1.0933e-02, -6.6289e-03, -8.5336e-03],
               [-1.1051e-03, 2.1900e-04, 6.1139e-03, 4.1133e-03, 6.0278e-03, 1.2057e-02, 9.9084e-01, 7.1461e-03,
                -1.7915e-03, 6.2292e-03, 3.4222e-03, -3.7711e-03],
               [-9.6519e-03, -1.9646e-03, -4.9123e-04, 1.2205e-02, 1.1886e-02, -2.0102e-02, 7.1461e-03, 1.0040e+00,
                -1.0451e-02, 7.9432e-03, 8.3770e-03, 1.1434e-02],
               [1.1300e-02, 6.9660e-03, 3.3132e-03, -8.4402e-03, -9.1059e-03, 1.9741e-02, -1.7915e-03, -1.0451e-02,
                1.0054e+00, -3.4430e-03, -4.7758e-03, -7.4684e-03],
               [-4.7062e-03, -4.1514e-03, -3.4634e-03, 6.9030e-03, 9.0760e-03, -1.0933e-02, 6.2292e-03, 7.9432e-03,
                -3.4430e-03, 9.9207e-01, 6.5706e-03, 6.3463e-03],
               [-3.8818e-03, 8.3130e-04, 1.3615e-03, 5.4126e-03, 4.5854e-03, -6.6289e-03, 3.4222e-03, 8.3770e-03,
                -4.7758e-03, 6.5706e-03, 9.9983e-01, 7.2641e-03],
               [-5.4262e-03, -2.7331e-03, -2.2931e-04, 1.0746e-02, 1.1655e-02, -8.5336e-03, -3.7711e-03, 1.1434e-02,
                -7.4684e-03, 6.3463e-03, 7.2641e-03, 9.9620e-01]], [
               [9.8995e-01, -7.1567e-03, -2.2415e-02, -9.9563e-04, 2.5955e-03, -4.3469e-05, 9.4325e-03, 2.9377e-03,
                9.8509e-04, -1.3403e-02, 7.8738e-03, 8.9423e-03],
               [-7.1567e-03, 9.9463e-01, -1.6706e-02, 9.6550e-04, 3.9050e-03, 1.2323e-04, 8.6002e-03, 3.6696e-03,
                -7.3661e-04, -1.6765e-02, 1.0737e-02, 1.1171e-02],
               [-2.2415e-02, -1.6706e-02, 1.0029e+00, 1.6429e-02, 1.8159e-02, -1.1953e-02, -7.8583e-03, 2.0692e-02,
                -2.2748e-02, 2.1246e-02, 5.0687e-03, 1.1932e-02],
               [-9.9563e-04, 9.6550e-04, 1.6429e-02, 1.0019e+00, -1.7564e-04, -3.7735e-03, -1.1439e-02, 1.6855e-03,
                -7.3192e-03, 1.8046e-02, -6.0976e-03, -3.7222e-03],
               [2.5955e-03, 3.9050e-03, 1.8159e-02, -1.7564e-04, 9.9557e-01, -1.3000e-03, -9.9650e-03, -1.6734e-03,
                -3.7279e-03, 1.8920e-02, -1.0550e-02, -8.7811e-03],
               [-4.3468e-05, 1.2323e-04, -1.1953e-02, -3.7735e-03, -1.3000e-03, 9.9652e-01, -2.8600e-04, -2.1687e-03,
                -6.7479e-05, -4.0988e-03, -4.3896e-03, -3.0000e-03],
               [9.4325e-03, 8.6002e-03, -7.8583e-03, -1.1439e-02, -9.9650e-03, -2.8600e-04, 1.0009e+00, -9.9483e-03,
                1.0571e-02, -6.9184e-03, -5.5824e-03, -6.0551e-03],
               [2.9377e-03, 3.6696e-03, 2.0692e-02, 1.6855e-03, -1.6734e-03, -2.1687e-03, -9.9483e-03, 9.9951e-01,
                -4.2508e-03, 1.3119e-02, -7.3181e-03, -7.9854e-03],
               [9.8509e-04, -7.3661e-04, -2.2748e-02, -7.3192e-03, -3.7279e-03, -6.7479e-05, 1.0571e-02, -4.2508e-03,
                1.0057e+00, -1.6728e-02, 2.5765e-03, 3.2004e-03],
               [-1.3403e-02, -1.6765e-02, 2.1246e-02, 1.8046e-02, 1.8920e-02, -4.0988e-03, -6.9184e-03, 1.3119e-02,
                -1.6728e-02, 1.0076e+00, 5.5539e-03, 8.7583e-03],
               [7.8738e-03, 1.0737e-02, 5.0687e-03, -6.0976e-03, -1.0550e-02, -4.3896e-03, -5.5824e-03, -7.3181e-03,
                2.5765e-03, 5.5539e-03, 9.9099e-01, -8.4413e-03],
               [8.9423e-03, 1.1171e-02, 1.1932e-02, -3.7222e-03, -8.7811e-03, -3.0000e-03, -6.0551e-03, -7.9854e-03,
                3.2004e-03, 8.7583e-03, -8.4413e-03, 9.8932e-01]]]

    mu = torch.from_numpy(np.asarray(mu))
    cov = torch.from_numpy(np.asarray(cov))

    sqrt_sigma_1, _ = get_matrix_sqrt(cov[1].unsqueeze(dim=0))
    sqrt_sigma_2, _ = get_matrix_sqrt(cov[2].unsqueeze(dim=0))
    p2 = torch.pow(sqrt_sigma_1 - sqrt_sigma_2, 2).sum()
    print(p2)

    Gaussian_Wasserstein(mu, cov)
